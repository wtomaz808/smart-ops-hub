@using SmartOpsHub.Core.Models
@using SmartOpsHub.Web.Services
@inject AgentChatService ChatService
@implements IAsyncDisposable

<div class="agent-chat-panel">
    <div class="agent-chat-header">
        <div class="agent-info">
            @if (!string.IsNullOrEmpty(Agent.AvatarUrl))
            {
                <img src="@Agent.AvatarUrl" alt="@Agent.Name" class="agent-avatar" />
            }
            else
            {
                <div class="agent-avatar agent-avatar-placeholder">@Agent.Name[0]</div>
            }
            <div class="agent-details">
                <span class="agent-name">@Agent.Name</span>
                <span class="agent-description">@Agent.Description</span>
            </div>
        </div>
        <AgentStatusIndicator Status="@_status" />
    </div>

    <div class="agent-chat-messages" @ref="_messagesContainer">
        @foreach (var message in _messages)
        {
            <ChatMessageBubble Message="@message" />
        }
        @if (_isStreaming)
        {
            <div class="message-bubble assistant-message streaming-message">
                <div class="message-content">@_streamingContent<span class="cursor-blink">â–Œ</span></div>
            </div>
        }
        @if (_status == AgentSessionStatus.Thinking)
        {
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        }
    </div>

    <div class="agent-chat-input">
        <input type="text"
               @bind="_inputMessage"
               @bind:event="oninput"
               @onkeydown="HandleKeyDown"
               placeholder="Type a message..."
               disabled="@(_status == AgentSessionStatus.Error)" />
        <button @onclick="SendMessage"
                disabled="@(string.IsNullOrWhiteSpace(_inputMessage) || _status == AgentSessionStatus.Error)">
            Send
        </button>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public AgentDefinition Agent { get; set; } = default!;

    private readonly List<ChatMessage> _messages = [];
    private AgentSessionStatus _status = AgentSessionStatus.Idle;
    private string _inputMessage = string.Empty;
    private string _streamingContent = string.Empty;
    private bool _isStreaming;
    private ElementReference _messagesContainer;
    private IDisposable? _messageSubscription;
    private IDisposable? _streamTokenSubscription;
    private IDisposable? _streamCompleteSubscription;
    private IDisposable? _statusSubscription;

    protected override async Task OnInitializedAsync()
    {
        await ChatService.ConnectAsync(Agent.Id, Guid.NewGuid().ToString());

        _messageSubscription = ChatService.OnMessageReceived(Agent.Id, message =>
        {
            _messages.Add(message);
            InvokeAsync(StateHasChanged);
        });

        _streamTokenSubscription = ChatService.OnStreamToken(Agent.Id, token =>
        {
            if (!_isStreaming)
            {
                _isStreaming = true;
                _streamingContent = string.Empty;
                _status = AgentSessionStatus.Working;
            }
            _streamingContent += token;
            InvokeAsync(StateHasChanged);
        });

        _streamCompleteSubscription = ChatService.OnStreamComplete(Agent.Id, () =>
        {
            if (_isStreaming)
            {
                _messages.Add(new ChatMessage
                {
                    Role = ChatRole.Assistant,
                    Content = _streamingContent
                });
                _streamingContent = string.Empty;
                _isStreaming = false;
                _status = AgentSessionStatus.Idle;
                InvokeAsync(StateHasChanged);
            }
        });

        _statusSubscription = ChatService.OnStatusChanged(Agent.Id, status =>
        {
            _status = status;
            InvokeAsync(StateHasChanged);
        });
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_inputMessage))
            return;

        var userMessage = new ChatMessage
        {
            Role = ChatRole.User,
            Content = _inputMessage
        };

        _messages.Add(userMessage);
        var messageText = _inputMessage;
        _inputMessage = string.Empty;

        _status = AgentSessionStatus.Thinking;
        await ChatService.SendMessageAsync(Agent.Id, messageText);
    }

    private async Task HandleKeyDown(Microsoft.AspNetCore.Components.Web.KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    public async ValueTask DisposeAsync()
    {
        _messageSubscription?.Dispose();
        _streamTokenSubscription?.Dispose();
        _streamCompleteSubscription?.Dispose();
        _statusSubscription?.Dispose();
        await ChatService.DisconnectAsync(Agent.Id);
    }
}

<style>
    .agent-chat-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        border: 1px solid #dee2e6;
        border-radius: 0.75rem;
        overflow: hidden;
        background: #fff;
    }

    .agent-chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .agent-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 0;
    }

    .agent-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .agent-avatar-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #0d6efd;
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .agent-details {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .agent-name {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .agent-description {
        font-size: 0.75rem;
        color: #6c757d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .agent-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .agent-chat-input {
        display: flex;
        padding: 0.75rem;
        border-top: 1px solid #dee2e6;
        gap: 0.5rem;
    }

    .agent-chat-input input {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 1.5rem;
        outline: none;
        font-size: 0.9rem;
    }

    .agent-chat-input input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    .agent-chat-input button {
        padding: 0.5rem 1.25rem;
        background: #0d6efd;
        color: white;
        border: none;
        border-radius: 1.5rem;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .agent-chat-input button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 0.6rem 1rem;
        background: #e9ecef;
        border-radius: 1rem;
        width: fit-content;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #6c757d;
        border-radius: 50%;
        animation: typing-bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    .streaming-message {
        background: #e9ecef;
        border-radius: 1rem;
        padding: 0.6rem 1rem;
        width: fit-content;
        max-width: 85%;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .cursor-blink {
        animation: blink 0.8s step-end infinite;
        color: #0d6efd;
    }

    @@keyframes blink {
        50% { opacity: 0; }
    }

    @@keyframes typing-bounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
        40% { transform: scale(1); opacity: 1; }
    }
</style>
